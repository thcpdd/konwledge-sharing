# 配置模块

*该模块决定了整个系统的稳定运行以及关乎到是否能够选课成功。*

---

该模块位于：`/snatcher/conf.py` 下。

## 模块介绍

这个文件下只有两个类：

- **SingletonMetaClass**

  单例元类，它继承于 `type`，当一个类指定了它为这个类的元类，那么这个类的对象是唯一的。

  一个简单的例子：

  ```python
  class A:
      pass
  
  a1 = A()
  a2 = A()
  print(a1 is a2)
  ```

  现在，你可以停下来猜想一下这段代码的输出结果。

  在 Python 中，关键字 `is` 用于判断两个对象的内存地址是否相同，相同返回真；反之。

  很明显这段代码的输出是 `False`。

  但是，如果我想让这段代码输出 `True` 呢？换句话说，输出 `True` 意味着什么呢？

  很明显，我是想让一个类的所有对象都是一样的，也就是说：无论这个类被创建多少次，它始终只返回同一个对象。

  > [!tip|label:为什么要同一个对象？]
  >
  > 你可以想象一下，如果创建这个类的代价很大，那么这会导致资源的开销很大。
  >
  > 例如这些场景：一个线程池类、一个数据库连接池类……
  >
  > 这些类在创建时的资源开销是非常大的，因此我不希望开销这么多的资源去创建它。
  >
  > 用一个词来概括上面的话：单例。

  那么配置类是不是也应该使用一个单例呢？

  你可以设想，这个配置类里的属性会自它被创建开始都会保持不变，因此创建多个配置类是没有意义的。

  那我们应该如何实现单例模式呢？

  我们可以将这个类的对象保存到类属性中，如果这个类属性为空，那么就创建对象；否则直接返回这个对象。

  > [!tip|label:为什么将对象保存到类属性中就能保证单例了呢？]
  >
  > 这里涉及到了 Python 中类的加载时机。说的简单点就是：当一个类被引入时，它的所有类属性以及定义在类板块中的逻辑都会被加载和执行，**并且相关的类属性都只会被加载一次**。
  >
  > 这是一个简单的例子：
  >
  > ```python
  > class A:
  >     print('loading')
  > ```
  >
  > 如果你在别的模块引入了这个类，那么你的代码应该会输出 `loading`。尽管这个类没有被创建，但 Python 解释器仍然执行了类板块下的所有逻辑。
  >
  > 对于更详细的解释，可以了解一下 Python 类的加载时机。

  因此我们完全可以使用这个特性来实现单例模式。对于详细的代码我就不过多解释了，因为里面还涉及到元类的知识，显然这些知识不是一两个篇幅的就能讲明白的。

- **Settings**

  这个类中包含了整个系统的所有配置，每一个配置都是一个类属性，让我来一个一个的介绍它们：
  
  1. `DEVELOPMENT_ENVIRONMENT`
  
     配置当前环境是否是开发环境。默认为 `True`。
  
     这个选项貌似只在数据库连接那里有效。如果这个值为真，那么在连接数据库时就会读取根目录下的 `mongodb_dev` 文件；否则会读取 `mongodb` 文件。
  
     这个配置是在本地开发的时候为了不将数据库配置泄露出去而新增的配置。
  
     **在你使用这个项目的时候应该将它的值改为 `False`。**
  
  2. `DATABASES`
  
     数据库连接配置项。
  
     当前的配置主要是 `Redis` 和 `MongoDB`。其中后者的配置会动态读取，当然你也可以直接在这个配置中编写连接配置。
  
  3. `TIMEOUT`
  
     全局选课超时时间，默认为 2 个小时。
  
     课程选择器发送的每一个请求都是带上这个超时时间。
  
  4. `SETTING_SESSION_TIMEOUT`
  
     登录超时时间，默认为 1 个小时。
  
     模拟登录的超时时间，模拟登录中的每一个请求都会带上这个超时时间。
  
  5. `TERM`
  
     选课学期，上学期为 3，下学期为 12.
  
  6. `SELECT_COURSE_YEAR`
  
     选课学年。
  
     无论是上学期还是下学期，都填写上学期的年份。例如，假设选课时间是 2025 年 4 月份，要填的就是上学期的年份 2024；假如选课时间是 2024 年 10 月份，那么当前学期就是上学期，直接填 2024 就行了。
  
     也就是填写 9 月份开学的年份。
  
  7. `PERIOD`
  
     学期阶段。
  
     一个学期可分为前半阶段（1）和后半阶段（2）。每个学期期中都会选一次公选课，以这个时间点为中心，前面的时间都归为前半学期，后面的时间都归为后半学期。
  
     这个配置主要是在数据库中要到，不是选课参数。
  
  8. `START_TIME`
  
     开始选课时间。
  
     按照时机的开始选课时间填写即可。
  
  9. `EMAIL_CONFIG`
  
     SMTP 邮件发送配置。
  
     这个配置的默认值是我的，因此你需要将这些配置更改为你自己的邮件发送配置。这个配置需要到对应的邮件服务中开通。
  
  10. `USE_TENCENT_CLOUD_MAIL_SERVICE`
  
      是否使用腾讯云服务来发送选课成功邮件。
  
  11. `PORTS`
  
      模拟登录时使用到的所有主机号。
  
  12. `SYSTEM_OPENING_TIME`
  
      系统开放时间。
  
      这个主要是限制后端提交预约抢课的时间，如果没到达这个时间，那么后端将不会发送选课任务。
  
  13. `ARQ_REDIS_SETTINGS`
  
      消息队列的 `Redis` 配置。
  
  除了配置项外，还有几个方法：
  
  1. `start_time`
  
     这个方法主要是将配置项中的开始选课时间转换为一个 `datetime` 对象。
  
  2. `system_opening_time`
  
     这个方法主要是将配置项中的系统开放时间转换为一个 `datetime` 对象。
  
  3. `countdown`
  
     获取当前时间到开始选课时间的倒计时（秒）。
  
  4. `get_mongodb_uri`
  
     从配置项中读取 `MongoDB` 的连接配置，如果配置项中的配置为空，那么读取根目录下的配置文件。

## 使用配置

在这个模块的最底下创建了一个 `Settings` 类的对象，你只需要在其他模块中引入这个对象即可：

```python
from snatcher.conf import settings
```
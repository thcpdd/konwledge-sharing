# 数据存储之数据库模块

*数据库保存了网站的所有数据，因此它是一个系统中最机密的一部分。*

---

这个项目使用的数据库是 `MongoDB`。但是项目的早期版本，使用的数据库是 `MySQL`。

更改数据库的原因有以下几点：

1. **项目数据量小**

   这点我觉得是最重要的一点。首先 `MySQL` 本身就适合那些大数据量、高并发等场景。但是这个项目本身就不具备那些特点，所以我觉得使用 `MySQL` 会浪费掉部分资源。

   相反 `MongoDB` 即使也支持海量存储、高并发场景，但相对于 `MySQL` 来说它是更轻量的，这非常符合这个项目的特点。

2. **不需要维护 `SQL` 语句**

   如果你想在代码层面舒畅地使用 `MySQL`，那么你可能需要引入一些 `ORM` 框架。这使得你操作数据库就像操作 Python 对象那样简单，从而不需要维护麻烦的 `SQL` 语句。

   > [!note|label:ORM（Object Relational Mapping）]
   >
   > 它的中文名称是：对象关系映射。它可以将一个表当作一个 Python 对象来操作。
   >
   > 假设一张表名是 `user`，那么你就可以使用 `user.` 的形式调用对象方法来操作这张表，例如：`user.create()`，这相当于是在 `user` 表中插入了一条新的记录。
   >
   > 如果你使用过 `Django` 框架，那么你应该能体会到 `ORM` 的魅力！

   倘如这个项目是一个纯 Web 项目，那么我甘愿引入 `ORM` 框架。但是数据库模块对于该项目来说是一个次要的模块，如果此时无脑的引入一个 `ORM` 框架，这样只会增加项目的复杂度。

   但是如果不引入 `ORM` 框架，那么这时你就需要维护大量的 `SQL` 语句。

   维护这些语句还是个小事情，更致命的问题是：手动维护 `SQL` 语句还会有  `SQL注入` 的风险！

   > [!note|label:SQL 注入]
   >
   > 一种 `SQL` 漏洞攻击技术，攻击者可以通过 `SQL` 语句的**注释符号**来编写“特殊”的 `SQL` 语句，这些语句很有可能以一种非法的方式将数据库中的机密数据查询出来！
   >
   > 因此这是网站开发者需要特别考虑的问题！

   但是 `MongoDB` 却不需要这些复杂的操作，尽管它也有可能被注入攻击，但它的概率相对于手动维护 `SQL` 来说是非常小的。

综合上面两点，我最终将数据库换成了 `MongoDB` 数据库。

关于操作 MongoDB 数据库的代码都在 `./snatcher/storage/mongo` 下。

其中里面包含了两个 Python 文件：

1. `base.py`

   二次封装 MongoDB 库，使得操作数据库变得更加简单。

   代码经过封装后，可以无需考虑连接层的代码，我们可以直接关注集合（数据表）的操作。

   这是一个简单的例子：

   ```python
   from snatcher.storage import collections
   
   user_collection = collections['user']
   user_collection.create()
   ```

   `collections` 将所有的集合都指向同一个对象，通过简单的中括号表达式就可以获取相应集合对象，通过这个对象就可以对集合进行增删改查等操作……

   > [!tip|label:灵感来源]
   >
   > 我为什么会想出这样的封装方式呢？
   >
   > 如果你学过 Django 框架，那么你应该知道 Django 框架操作数据库主要使用 ORM 来操作。
   >
   > 但是，在一些极端情况下，通过 ORM 操作数据库的效率是非常低下，因此我们不得不想方设法通过 SQL 语句的形式去操作数据库。
   >
   > 那么在 Django 中同样提供了一种直接操作数据库的办法。例如：
   >
   > ```python
   > from django.db import connections
   > 
   > connection = connections['your_connection_name']
   > cursor = connection.cursor()
   > sql = 'SELECT * FROM user;'
   > cursor.execute(sql)
   > ```
   >
   > 当你在 Django 中配置了多个数据库连接时，你应该会用到这样的操作。
   >
   > 除此之外，如果你还在 Django 中使用了多个缓存后端，那么你应该也会见过下面的代码：
   >
   > ```python
   > from django.core.cache import caches
   > 
   > custom_cache = caches['your_cache_name']
   > ```
   >
   > 不管是哪一种代码，Django 的实现方式其实都是类似的，它们都通过对象的特殊接口 + 资源懒加载的形式实现。因此我的封装灵感来源于 Django 源码。
   >
   > **所以，阅读一些框架源码可以在很大程度上提高你的工程能力。这点是绝大多数程序员容易忽略的一点。**

2. `shortcuts.py`

   它提供了一些操作数据库的快捷函数。

通过上述的一系列封装，其它模块就可以很方便的使用这些对象来操作数据库了。

